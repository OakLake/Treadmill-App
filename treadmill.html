<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Treadmill Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="font-mono justify-center bg-black">
    <div x-data="treadmillController()" class="p-20 justify-center text-white">
      <h2
        class="bg-gradient-to-r from-green-500 to-red-500 bg-clip-text text-2xl font-extrabold text-transparent text-center"
      >
        Treadmill Controller üèÉ
      </h2>
      <!-- LIVE DATA SECTION -->
      <h1 class="mt-5 text-center">Live Data</h1>
      <div class="p-2 grid md:grid-cols-2 lg:grid-cols-5 gap-2 text-center">
        <p class="bg-gray-600 text-bold rounded-md p-4">
          Speed (km/h)<br /><span class="font-extrabold" x-text="data.speed"></span>
        </p>
        <p class="bg-gray-600 text-bold rounded-md p-4">
          Distance (m)<br /><span class="font-extrabold" x-text="data.distance"></span>
        </p>
        <p class="bg-gray-600 text-bold rounded-md p-4">
          Steps<br /><span class="font-extrabold" x-text="data.steps"></span>
        </p>
        <p class="bg-gray-600 text-bold rounded-md p-4">
          Time<br /><span class="font-extrabold" x-text="data.time"></span>
        </p>
        <p class="bg-gray-600 text-bold rounded-md p-4">
          Calories<br /><span class="font-extrabold" x-text="data.calories"></span>
        </p>
      </div>
      <!-- LIVE DATA SECTION END-->

      <div class="p-3 text-center">
        <h1 class="p-3 text-center">Control</h1>
        <div class="p-2 grid md:grid-cols-1 lg:grid-cols-2 gap-2 text-center">
          <button
            @click="startTreadmill"
            class="p-3 bg-gradient-to-r from-green-500 to-green-600 active:bg-green-700 text-bold rounded-md font-extrabold"
          >
            Start
          </button>
          <button
            @click="stopTreadmill"
            class="p-3 bg-gradient-to-r from-red-500 to-red-600 active:bg-red-700 text-bold rounded-md font-extrabold"
          >
            Stop
          </button>
        </div>
      </div>

      <div class="text-center">
        <h1 class="p-3">Speed</h1>
        <button
          @click="increaseSpeed"
          class="py-3 px-8 m-1 bg-gradient-to-r from-green-500 to-green-600 active:bg-green-700 text-bold rounded-md font-extrabold"
        >
          +
        </button>
        <button
          @click="decreaseSpeed"
          class="py-3 px-8 m-1 bg-gradient-to-r from-red-500 to-red-600 active:bg-red-700 text-bold rounded-md font-extrabold"
        >
          -
        </button>
      </div>

      <div class="p-3 text-center">
        <h2 class="p-3">Select a Workout</h2>
        <select class="bg-gray-600" x-model="selectedWorkout" @change="updateWorkoutPlan">
          <template x-for="(workout, index) in workouts" :key="index">
            <option :value="index" x-text="workout.name"></option>
          </template>
        </select>

        <div class="p-6">
          <button
            @click="startWorkout"
            class="p-3 bg-gradient-to-r from-green-500 to-green-600 active:bg-green-700 text-bold rounded-md font-extrabold"
          >
            Start Workout
          </button>
        </div>

        <h2 class="p-3 text-center" x-show="selectedWorkoutData.length">Workout Plan</h2>
        <ul class="text-left px-30">
          <template x-for="(segment, index) in selectedWorkoutData" :key="index">
            <li>Speed: <span x-text="segment[0]"></span> m/s, Duration: <span x-text="segment[1]"></span> sec</li>
          </template>
        </ul>
      </div>
    </div>

    <script>
      function treadmillController() {
        return {
          data: { speed: "-", distance: "-", steps: "-", calories: "-", time: "-" },
          workouts: [],
          selectedWorkout: 0,
          selectedWorkoutData: [],
          ws: null,

          init() {
            this.getWorkouts();

            this.ws = new WebSocket("ws://localhost:8000/ws");
            this.ws.onmessage = (event) => {
              let newData = JSON.parse(event.data);
              this.data.speed = newData.speed_ms;
              this.data.time = newData.time;
              this.data.distance = newData.distance_m;
              this.data.steps = newData.steps;
              this.data.calories = newData.calories;
            };
          },

          getWorkouts() {
            fetch("http://localhost:8000/workouts")
              .then((response) => response.json())
              .then((data) => {
                this.workouts = data;
                this.selectedWorkoutData = this.workouts[this.selectedWorkout].plan;
              })
              .catch((error) => console.error("Error fetching workouts:", error));
          },

          updateWorkoutPlan() {
            this.selectedWorkoutData = this.workouts[this.selectedWorkout].plan;
          },

          startTreadmill() {
            fetch("http://localhost:8000/start", { method: "POST" });
          },

          startWorkout() {
            fetch("http://localhost:8000/start-workout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name: this.workouts[this.selectedWorkout].name }),
            });
          },

          resumeTreadmill() {
            fetch("http://localhost:8000/resume", { method: "POST" });
          },

          stopTreadmill() {
            fetch("http://localhost:8000/stop", { method: "POST" });
          },

          increaseSpeed() {
            fetch(`http://localhost:8000/speed?value=${parseFloat(this.data.speed) + 0.1}`, {
              method: "POST",
            });
          },

          decreaseSpeed() {
            fetch(`http://localhost:8000/speed?value=${parseFloat(this.data.speed) - 0.1}`, {
              method: "POST",
            });
          },
        };
      }
    </script>
  </body>
</html>
